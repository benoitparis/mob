<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/p5.js"></script>
<script>
	function setup() {
		createCanvas(1200, 600);
	}

	var mobX = 600;
	var mobY = 300;

	function draw() {
		background(255, 247, 240);
		fill(127, 198, 0);
		ellipse(mobX, mobY, 80, 80);
		fill(198, 127, 0);
		ellipse(mouseX, mouseY, 40, 40);
	}

	function greetInit(evt) {
		console.log('connection established');
		console.log(evt);
	};

	function updateServerPosition(evt) {
		console.log(evt);
		console.log(JSON.parse(evt.data));
		var msg = JSON.parse(evt.data);
		mobX = msg.payload.X;
		mobY = msg.payload.Y;
		draw();
	};

	var ws;
  function wsConnect() {
		var mypath = "/service"
		var wsUrl = "ws://" + window.location.host + mypath + "/ws";
		ws = new WebSocket(wsUrl);
		ws.onopen = greetInit;
		ws.onmessage = updateServerPosition;
		ws.onclose = wsOnClose;
	}
  
  
	function sendPosition() {
		if (ws && ws.readyState === WebSocket.OPEN) {
			var msg = {
				X : mouseX,
				Y : mouseY
			};
			var serverMsg = {
				intent : 'WRITE',
				table : 'write_position',
				payload : msg
			};
			console.log(serverMsg);
			ws.send(JSON.stringify(serverMsg));
		}
	}
	setInterval(sendPosition, 37);
  
	function queryGlobalPosition() {
		if (ws && ws.readyState === WebSocket.OPEN) {
			var serverMsg = {
				intent : 'WRITE',
				table : 'query_global_position',
				payload : {}
			};
			console.log(serverMsg);
			ws.send(JSON.stringify(serverMsg));
		}
	}
	setInterval(queryGlobalPosition, 41);


	
	function wsOnClose(evt) {
		console.log("WS CLOSE");
		console.log(evt);
	}
	
</script>
</head>
<body>
	HELLO
	<button onclick="wsConnect()">Connect WS</button>
</body>
</html>