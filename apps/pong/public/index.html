<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js"></script>
<!-- plein de collisions de globales, TODO faudra nettoyer -->
<script src="/app/pong/game.js"></script>
<script type="text/javascript">

  var buttonHeight = 30;
  var scalingWidth = 1.0;
  var scalingHeight = 1.0;
  
  // UI game
  var mouseY;
  function setup() {
    var canvas = createCanvas(windowWidth, windowHeight - buttonHeight);
    scalingWidth = windowWidth/width;
    scalingHeight = (windowHeight - buttonHeight)/height;
    canvas.parent('sketch-holder');
    mouseY = mouseY;
  }
  function windowResized() {
    resizeCanvas(windowWidth, windowHeight - buttonHeight);
    scalingWidth = windowWidth/width;
    scalingHeight = (windowHeight - buttonHeight)/height;
  }
  

  function scaleRect(x, y, xl, yl) {
    rect(
      x  * scalingWidth, y  * scalingHeight,
      xl * scalingWidth, yl * scalingHeight
    );
  }
  function unScaleHeight(y) {
    return y / scalingHeight;
  }
  function boxY(y) {
    return Math.min(windowHeight - buttonHeight, y)
  }
  
  var side;
  
  var lastAccurateDataTime;
  var lastInterpolationTime = 0;
  const MAX_INTERPOLATION_MS = 300;
  function draw() {
    
    var now = new Date().getTime();
    var deltatime;
    if (0 !== lastInterpolationTime) {
      deltatime = now - lastInterpolationTime;
    } else {
      deltatime = 0;
    }
    lastInterpolationTime = now;
    // client interpolation
    if (0 !== deltatime && lastAccurateDataTime && (now - lastAccurateDataTime < MAX_INTERPOLATION_MS)) {
      updateGame(deltatime);
    }
    
    background(255, 247, 240);
    fill(0, 0, 0);
    scaleRect(leftDistance , state.game.leftY  - racketHeight/2, racketWidth, racketHeight);
    scaleRect(rightDistance, state.game.rightY - racketHeight/2, racketWidth, racketHeight);
    fill(0, 0, 255);
    if (state.side) {
      if (state.side === 'left') {
        scaleRect(leftDistance, unScaleHeight(boxY(mouseY)) - racketHeight/2, racketWidth, racketHeight);
      } else if (state.side === 'right') {
        scaleRect(rightDistance, unScaleHeight(boxY(mouseY)) - racketHeight/2, racketWidth, racketHeight);
      }
    }
    fill(0, 0, 0);
    scaleRect(state.game.ballX - ballRadius, state.game.ballY - ballRadius, ballDiameter, ballDiameter);
    // draw se fait requestAnimationFramer? du coup on mettrait de l'interpolation ici?
        
  }
  
  // UI buttons
  function updateSide() {
    document.getElementById('side-chosen-left').style.borderStyle = null;
    document.getElementById('side-chosen-observe').style.borderStyle = null;
    document.getElementById('side-chosen-right').style.borderStyle = null;
    document.getElementById('side-chosen-' + state.side + '').style.borderStyle = 'inset';
  }
  function updateScoresAndCounts() {
    document.getElementById('side-chosen-left-text').innerHTML = 'Play as Left (score: ' + state.game.scoreLeft + ', users #: ' + state.user_count.countLeft + ')';
    document.getElementById('side-chosen-observe-text').innerHTML = 'Observe (users #: ' + state.user_count.countObserve + ')';
    document.getElementById('side-chosen-right-text').innerHTML = 'Play as Right (score: ' + state.game.scoreRight + ', users #: ' + state.user_count.countRight + ')';
  }
  
  // credits to https://stackoverflow.com/questions/879152/how-do-i-make-javascript-beepvar
  //var snd = new Audio("data:audio/wav;base64,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qJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");
  //function beep() {
  //  snd.play();
  //}

  // Network setup
  function processServerMessage(evt) {
    var msg = JSON.parse(evt.data);
    if (msg.table === 'ack_side') {
      state.side = msg.payload.side;
      updateSide();
    } else if (msg.table === 'game_out_to_client') {
      //console.log(Math.sign(state.game.speedX));
      //console.log(Math.sign(msg.payload.speedX));
      //if (Math.sign(state.game.speedX) !== Math.sign(msg.payload.speedX)) {
      //  beep();
      //}
    
      state.game = msg.payload;
      lastAccurateDataTime = new Date().getTime();
      updateScoresAndCounts();
    } else if (msg.table === 'user_count') {
      state.user_count = msg.payload;
      updateScoresAndCounts();
    } else {
      console.log('received msg of unknown table:');
      console.log(msg);
    }
  };
  
  var appName = window.location.pathname.replace('/app/', '').replace('/', '');
  var ws;
  
  function sendToServer(table, msg) {
    // TODO queuing? because si ws était pas prête, on drop
    if (ws && ws.readyState === WebSocket.OPEN) {
      var serverMsg = {
        intent : 'WRITE',
        table : appName + '.' + table,
        payload : msg
      };
      ws.send(JSON.stringify(serverMsg));
    }
  }
  
  function logEvent(evt) {
    console.log(evt);
  };
  
  function wsConnect() {
    var mypath = "/service"
    var wsUrl = "ws://" + window.location.host + mypath + "/ws";
    ws = new WebSocket(wsUrl);
    ws.onopen = logEvent;
    ws.onclose = logEvent;
    ws.onmessage = processServerMessage;
  }
  wsConnect();
  
  
  
  
  // Network business
  function chooseSide(e) {
    console.log(e);
    sendToServer('choose_side', {side : e});
  }
  
  var lastSentMouseY;
  function sendPosition() {
    var trueY = unScaleHeight(boxY(mouseY));
    if(lastSentMouseY !== trueY) {
      lastSentMouseY = trueY;
      sendToServer('write_y', {y : trueY});
    }
  }

  // TODO try the internal subscription mecanism
  function getGlobalPosition() {
    sendToServer('query_global_position', {now : '' + Date.now()});
  }
  
  setInterval(sendPosition, 40);
  setInterval(getGlobalPosition, 41);
  

</script>
</head>
<body style="margin: 0;">
  <div id="game">
    <div id="sketch-holder"></div>
    <div id="button-sides" style="display: flex;height: 30px;">
    
      <button id="side-chosen-left"    type="button" onclick="chooseSide('left');"    style="outline: none; flex-basis: 100%; width:100%;">
        <span id="side-chosen-left-text"   >Observe</span>
      </button>
      <button id="side-chosen-observe" type="button" onclick="chooseSide('observe');" style="outline: none; flex-basis: 100%; width:100%;border-style:inset;">
        <span id="side-chosen-observe-text">Observe</span>
      </button>
      <button id="side-chosen-right"   type="button" onclick="chooseSide('right');"   style="outline: none; flex-basis: 100%; width:100%;">
        <span id="side-chosen-right-text"  >Play as Right</span>
      </button>
    </div>
  </div>
</body>
</html>