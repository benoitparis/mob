<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js"></script>
<!-- plein de collisions de globales, TODO faudra nettoyer -->
<script src="/app/pong/game.js"></script>
<script>

  var MAX_INTERPOLATION_MS = 300;
  
  // UI
  var mouseY;
  function setup() {
    createCanvas(1200, 600);
    mouseY = mouseY;
  }
  
  var side;
  
  var lastAccurateDataTime;
  var lastInterpolationTime = 0;
  function draw() {
    
    var now = new Date().getTime();
    var deltatime;
    if (0 !== lastInterpolationTime) {
      deltatime = now - lastInterpolationTime;
    } else {
      deltatime = 0;
    }
    lastInterpolationTime = now;
    // client interpolation
    if (0 !== deltatime && lastAccurateDataTime && (now - lastAccurateDataTime < MAX_INTERPOLATION_MS)) {
      updateGame(deltatime);
    }
    
    background(255, 247, 240);
    fill(0, 0, 0);
    rect(leftDistance , leftY  - racketHeight/2, racketWidth, racketHeight);
    rect(rightDistance, rightY - racketHeight/2, racketWidth, racketHeight);
    fill(0, 0, 255);
    if (side) {
      if (side === 'left') {
        rect(leftDistance, mouseY - racketHeight/2, racketWidth, racketHeight);
      } else if (side === 'right') {
        rect(rightDistance, mouseY - racketHeight/2, racketWidth, racketHeight);
      }
    }
    fill(0, 0, 0);
    rect(ballX - ballRadius, ballY - ballRadius, ballDiameter, ballDiameter);
    // draw se fait requestAnimationFramer? du coup on mettrait de l'interpolation ici?
    
  }
  

  // Network setup
  function processServerMessage(evt) {
    var msg = JSON.parse(evt.data);
    if (msg.table === 'ack_side') {
      document.getElementById('side-' + msg.payload.side + '-chosen').checked = true;
      side = msg.payload.side;
    } else if (msg.table === 'game_out_to_client') {
      ballX = msg.payload.ballX;
      ballY = msg.payload.ballY;
      speedX = msg.payload.speedX;
      speedY = msg.payload.speedY;
      leftY  = msg.payload.leftY;
      rightY = msg.payload.rightY;
      scoreLeft = msg.payload.scoreLeft;
      scoreRight = msg.payload.scoreRight;
      
      lastAccurateDataTime = new Date().getTime();
      document.getElementById('score').innerHTML = 'Score: ' + scoreLeft + ' : ' + scoreRight;
    } else if (msg.table === 'user_count') {
      var countLeft = msg.payload.countLeft;
      var countRight = msg.payload.countRight;
      var countGlobal  = msg.payload.countGlobal;
      document.getElementById('user-count').innerHTML = 'User count: ' + countLeft + ' + ' + countRight + ' = ' + countGlobal;
    } else {
      console.log('received msg of unknown table:');
      console.log(msg);
    }
  };
  
  var appName = window.location.pathname.replace('/app/', '').replace('/', '');
  var ws;
  
  function sendToServer(table, msg) {
    // TODO queuing? because si ws était pas prête, on drop
    if (ws && ws.readyState === WebSocket.OPEN) {
      var serverMsg = {
        intent : 'WRITE',
        table : appName + '.' + table,
        payload : msg
      };
      ws.send(JSON.stringify(serverMsg));
    }
  }
  
  function logEvent(evt) {
    console.log(evt);
  };
  
  function wsConnect() {
    var mypath = "/service"
    var wsUrl = "ws://" + window.location.host + mypath + "/ws";
    ws = new WebSocket(wsUrl);
    ws.onopen = logEvent;
    ws.onclose = logEvent;
    ws.onmessage = processServerMessage;
  }
  wsConnect();
  
  
  
  
  
  
  // Network business
  function chooseSide(e) {
    sendToServer('choose_side', {side : e});
  }
  
  var lastSentMouseY;
  function sendPosition() {
    if(lastSentMouseY !== mouseY) {
      lastSentMouseY = mouseY;
      sendToServer('write_y', {y : mouseY});
    }
  }

  // TODO try the internal subscription mecanism
  function getGlobalPosition() {
    sendToServer('query_global_position', {now : '' + Date.now()});
  }
  
  setInterval(sendPosition, 40);
  setInterval(getGlobalPosition, 41);
  
</script>
</head>
<body>
  <div>
    <div id="side-chooser">
      <input type="radio" id="side-left"  name="side" value="left"  onclick="chooseSide('left');" style="border:1px black;">
      <label for="side-left">Left</label>
      <input type="radio" id="side-right" name="side" value="right" onclick="chooseSide('right');">
      <label for="side-right">Right</label>
      (2. Choose side)
    </div>
    
    <div id="side-chosen">
      <input type="radio" id="side-left-chosen"  name="side-chosen" value="left" disabled>
      <label for="side-left">Left</label>
      <input type="radio" id="side-right-chosen" name="side-chosen" value="right" disabled>
      <label for="side-right">Right</label>
      (3. Server ack)
    </div>
    
    <div id="user-count">
      User count: 0 + 0 = 0
    </div>
    
    <div id="score">
      Score: 0 : 0
    </div>
    
  </div>
</body>
</html>